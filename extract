#!/usr/bin/perl

for ($i = 0; $i < 71; $i++) {
	$line[$i] = <>;

	chomp $line[$i];
	$line[$i] =~ s/\015//g;
	$line[$i] =~ s/<\/p><\/th>//;
	$line[$i] =~ s/  <th valign=TOP nowrap><p>//;
	$line[$i] =~ s/  <th valign=TOP align=LEFT nowrap><p>//;
}

$line[68] =~ s/Weather: //;
$line[66] =~ s/Coordinate: //;
$line[58] =~ s/,//g;

print "$line[68]\n";
print "$line[66]\n";
print "$line[60]\n";
print "$line[58]\n";

$coord = $line[66];
$weather = $line[68];
$name = $line[60];
$date = $line[58];

open(IN, "intersection_movements_traffic_counts.kml");
while (<IN>) {
	if (/coordinate=$coord/) {
		$found = 1;
	}

	if (/<coordinates>([0-9.-]*),([0-9.-]*)/) {
		if ($found) {
			$lon = $1;
			$lat = $2;
			last;
		}
	}
}

print "$lat,$lon\n";

while (<>) {
	chomp;
	s/\015//;

	if (/^<tr><th>(North|South|East|West)/) {
		s/ class='g'//g;
		s/<\/th>//g;
		s/<\/TH>//g;
		s/<BR>/ /g;
		s/<tr>//g;
		s/ +/ /g;
		s/^<th>//;
		s/<th>/,/g;
		s/ *,/,/g;

		@headers = split(/, */);
		$direction = $headers[0];

		# print;
	}

	if (/<tr><th class='g' nowrap>(AM|PM) Max Hour/) {
		s/ class='g'//g;
		s/ nowrap//g;
		s/<\/th>//g;
		s/<\/TH>//g;
		s/<\/td>//g;
		s/<\/TD>//g;
		s/<BR>/ /g;
		s/<tr>//g;
		s/ +/ /g;
		s/^<th>//;
		s/<TD>/,/g;
		s/<th>/,/g;
		s/ *,/,/g;

		@cols = split(/, */);
		$peak_time = $cols[0];

		for ($i = 1; $i <= $#cols; $i++) {
			if ($headers[$i] =~ /Left/) {
				$peak{'left'}{$direction} += $cols[$i];
			}
			if ($headers[$i] =~ /Right/) {
				$peak{'right'}{$direction} += $cols[$i];
			}
			if ($headers[$i] =~ /Thru/) {
				$peak{'thru'}{$direction} += $cols[$i];
			}
			if ($headers[$i] =~ /Bikes/) {
				$peak{'bikes'}{$direction} += $cols[$i];
			}
			if ($headers[$i] =~ /Peds/) {
				$peak{'peds'}{$direction} += $cols[$i];
			}
		}
	}

	if (/<tr><th class='g' nowrap>2 Hour Totals/) {
		s/ class='g'//g;
		s/ nowrap//g;
		s/<\/th>//g;
		s/<\/TH>//g;
		s/<\/td>//g;
		s/<\/TD>//g;
		s/<BR>/ /g;
		s/<br>/ /g;
		s/<tr>//g;
		s/ +/ /g;
		s/^<th>//;
		s/<TD>/,/g;
		s/<th>/,/g;
		s/ *,/,/g;
	}

	if (/<table border=1 cellspacing=0 cellpadding=0 width=350>/) {
		print "$coord,$name,$coord,$date,$peak_time,";

		for $direction ("North", "East", "West", "South") {
			print "$peak{'left'}{$direction},$peak{'thru'}{$direction},$peak{'right'}{$direction},";
		}
		for $direction ("North", "East", "West", "South") {
			print "$peak{'peds'}{$direction},";
		}
		for $direction ("North", "East", "West", "South") {
			print "$peak{'bikes'}{$direction},";
		}

		%peak = ();

		print "\n";
	}
}

